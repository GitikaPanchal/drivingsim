<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Driving Sim</title>
    <link rel="icon" href="steering.png" type="image/png" />
    <style>
      body {
        margin: 0;
        display: flex;
        font-family: Arial, sans-serif;
        overflow: hidden;
      }
      #game {
        flex: 2;
        height: 100vh;
        background: linear-gradient(#555, #222);
        position: relative;
        overflow: hidden;
      }
      #dashboard {
        flex: 1;
        background: #f4f4f4;
        padding: 20px;
        box-shadow: -2px 0 5px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        justify-content: start;
      }
      #road {
        position: absolute;
        width: 100%;
        height: 100%;
        background: #333;
        overflow: hidden;
      }
      .lane-set {
        position: absolute;
        width: 100%;
        height: 100%;
        will-change: transform;
      }
      /* Modified lane-line style to make it look like actual road markers */
      .lane-line {
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        width: 10px;
        height: 30px; /* Shorter lines */
        background: white;
        border-radius: 2px; /* Slightly rounded edges */
      }
      #car {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%) rotate(180deg);
        width: 60px;
        height: 120px;
        background: url("car.png") no-repeat center center;
        background-size: cover;
      }
      #controls button {
        margin-top: 10px;
        padding: 10px;
        width: 100%;
      }
      #cruiseButton {
        position: relative;
      }
      #cruiseButton.active {
        background-color: #d4f8d4;
        border-color: #5cb85c;
      }
      .cruise-indicator {
        display: inline-block;
        background-color: #ddd;
        color: #333;
        font-size: 11px;
        padding: 2px 6px;
        border-radius: 10px;
        margin-left: 5px;
      }
      .cruise-indicator.on {
        background-color: #5cb85c;
        color: white;
      }
      .mechanical-diagram {
        padding: 10px;
        background: #fff;
        border: 1px solid #ccc;
        border-radius: 10px;
        position: relative;
      }
      .mechanical-diagram svg {
        width: 100%;
        height: 200px;
      }
      .mechanical-label {
        font-size: 12px;
        fill: #000;
      }
      /* Speedometer styles */
      #speedometer {
        margin: 20px 0;
        position: relative;
        width: 100%;
        height: 150px;
      }
      .speedometer-container {
        position: relative;
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: flex-end;
        border-radius: 50% 50% 0 0;
        overflow: hidden;
        background: #222;
        border: 2px solid #444;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      }
      .speed-tick {
        position: absolute;
        bottom: 0;
        left: 50%;
        width: 2px;
        height: 10px;
        background-color: rgba(255, 255, 255, 0.7);
        transform-origin: bottom center;
      }
      .speed-tick.major {
        height: 15px;
        width: 3px;
        background-color: white;
      }
      .speed-value {
        position: absolute;
        color: #222;
        font-size: 10px;
        transform-origin: bottom center;
        bottom: 20px;
      }
      .speedometer-needle {
        position: absolute;
        bottom: 0;
        left: 50%;
        width: 4px;
        height: 70%;
        background: linear-gradient(to top, red 60%, transparent);
        transform-origin: bottom center;
        transform: rotate(0deg);
        transition: transform 0.3s ease-out;
        z-index: 10;
      }
      .needle-center {
        position: absolute;
        bottom: -5px;
        left: 50%;
        transform: translateX(-50%);
        width: 16px;
        height: 16px;
        background: #ddd;
        border: 2px solid #aaa;
        border-radius: 50%;
        z-index: 11;
      }
      .speed-display {
        position: absolute;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.7);
        color: #fff;
        padding: 5px 10px;
        border-radius: 5px;
        font-size: 16px;
        z-index: 12;
      }

      /* Popup modal styles */
      .mechanical-part {
        cursor: pointer;
      }
      .mechanical-part:hover {
        opacity: 0.8;
      }
      #infoPopup {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
      }
      .popup-content {
        background-color: #fff;
        width: 80%;
        max-width: 500px;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        padding: 20px;
        position: relative;
      }
      .popup-title {
        color: #5cb85c;
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 10px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
      }
      .popup-description {
        color: #333;
        font-size: 14px;
        line-height: 1.5;
      }
      .popup-close {
        position: absolute;
        top: 10px;
        right: 10px;
        font-size: 24px;
        color: #999;
        cursor: pointer;
        background: none;
        border: none;
        padding: 0;
        width: 30px;
        height: 30px;
        line-height: 30px;
        text-align: center;
      }
      .popup-close:hover {
        color: #555;
      }
    </style>
  </head>
  <body>
    <div id="game">
      <div id="road"></div>
      <div id="car"></div>
    </div>
    <div id="dashboard">
      <div>
        <!-- Speedometer component -->
        <div id="speedometer">
          <div class="speedometer-container">
            <div class="speedometer-needle"></div>
            <div class="needle-center"></div>
            <div class="speed-display">0 km/h</div>
          </div>
        </div>

        <!-- Controls -->
        <div id="controls">
          <button>Accelerate</button>
          <button>Decelerate</button>
          <button id="cruiseButton">
            Cruise Control <span class="cruise-indicator">OFF</span>
          </button>
        </div>
        <h3>Mechanics</h3>
        <p id="mechanicsLog">Waiting for action...</p>
      </div>

      <div class="mechanical-diagram">
        <svg viewBox="0 0 300 200">
          <!-- Driver Input Section -->
          <g
            id="driver-input"
            class="mechanical-part"
            data-title="Accelerator Pedal"
            data-description="The driver's primary control for adjusting vehicle speed. When pressed, it sends a mechanical signal to the throttle, increasing fuel flow to the engine and raising vehicle speed. The pedal is spring-loaded to return to idle position when released."
          >
            <rect
              x="10"
              y="40"
              width="40"
              height="20"
              fill="#ddd"
              stroke="#999"
              stroke-width="1"
            />
            <text x="30" y="35" class="mechanical-label" text-anchor="middle">
              Accelerator Pedal
            </text>
          </g>

          <!-- Cruise Control Switch -->
          <g
            id="cruise-switch"
            class="mechanical-part"
            data-title="Cruise Control Switch"
            data-description="Activates the cruise control system, allowing the vehicle to maintain a constant speed without driver input on the accelerator. When engaged, it tells the ECU to take over throttle control. The indicator light shows when the system is active."
          >
            <rect
              x="10"
              y="90"
              width="40"
              height="20"
              fill="#ddd"
              stroke="#999"
              stroke-width="1"
            />
            <text x="30" y="85" class="mechanical-label" text-anchor="middle">
              Cruise Control Switch
            </text>
            <rect
              id="cruise-indicator"
              x="15"
              y="95"
              width="10"
              height="10"
              fill="gray"
            />
          </g>

          <!-- ECU (Electronic Control Unit) -->
          <g
            id="ecu-unit"
            class="mechanical-part"
            data-title="Electronic Control Unit (ECU)"
            data-description="The 'brain' of the cruise control system. It receives input from the speed sensor and cruise control switch, then calculates the appropriate throttle position to maintain the desired speed. The ECU uses a closed-loop feedback system to make continuous adjustments."
          >
            <rect
              x="100"
              y="130"
              width="60"
              height="40"
              fill="#eee"
              stroke="#999"
              stroke-width="1"
            />
            <text x="130" y="125" class="mechanical-label" text-anchor="middle">
              ECU
            </text>
            <circle id="ecuLight" cx="115" cy="150" r="8" fill="gray" />
            <text
              x="115"
              y="170"
              class="mechanical-label"
              text-anchor="middle"
              font-size="10"
            >
              Status
            </text>
          </g>

          <!-- Speed Sensor -->
          <g
            id="speed-sensor"
            class="mechanical-part"
            data-title="Speed Sensor"
            data-description="Monitors the vehicle's actual speed by measuring wheel rotation or driveshaft movement. It converts mechanical motion into electronic signals that the ECU can interpret. Without accurate speed data, the cruise control system cannot function properly."
          >
            <circle
              cx="100"
              cy="90"
              r="15"
              fill="#eee"
              stroke="#999"
              stroke-width="1"
            />
            <text x="100" y="75" class="mechanical-label" text-anchor="middle">
              Speed Sensor
            </text>
            <path
              d="M95,90 L105,90 M100,85 L100,95"
              stroke="#333"
              stroke-width="1"
            />
          </g>

          <!-- Throttle Actuator -->
          <g
            id="throttle"
            class="mechanical-part"
            data-title="Throttle Actuator"
            data-description="Controls the opening and closing of the throttle valve that regulates airflow to the engine. In cruise control mode, the ECU sends signals to the actuator to adjust throttle position automatically. During normal driving, it responds to the accelerator pedal position."
          >
            <rect
              x="190"
              y="60"
              width="40"
              height="30"
              fill="#eee"
              stroke="#999"
              stroke-width="1"
            />
            <text x="210" y="55" class="mechanical-label" text-anchor="middle">
              Throttle Actuator
            </text>
            <rect
              id="throttle-position"
              x="195"
              y="70"
              width="30"
              height="10"
              fill="#aaa"
            />
          </g>

          <!-- Engine -->
          <g
            id="engine"
            class="mechanical-part"
            data-title="Engine"
            data-description="Converts fuel energy into mechanical power to drive the vehicle. The engine's power output is directly controlled by the throttle position. When cruise control is active, the ECU maintains consistent engine power to hold a steady speed despite changing conditions like hills or wind resistance."
          >
            <rect
              x="240"
              y="120"
              width="50"
              height="40"
              fill="#ddd"
              stroke="#999"
              stroke-width="1"
              rx="5"
              ry="5"
            />
            <text x="265" y="115" class="mechanical-label" text-anchor="middle">
              Engine
            </text>
            <path
              d="M245,135 L250,130 L255,135 L260,130 L265,135 L270,130 L275,135 L280,130 L285,135"
              stroke="#666"
              stroke-width="1.5"
              fill="none"
            />
          </g>

          <!-- Connection Lines -->
          <!-- Driver to Throttle -->
          <line
            x1="50"
            y1="50"
            x2="190"
            y2="75"
            stroke="#333"
            stroke-width="1.5"
            stroke-dasharray="4,2"
            id="manual-control"
          />

          <!-- Cruise Switch to ECU -->
          <line
            x1="50"
            y1="100"
            x2="100"
            y2="130"
            stroke="#333"
            stroke-width="1.5"
            id="cruise-command"
          />

          <!-- Speed Sensor to ECU -->
          <line
            x1="100"
            y1="105"
            x2="110"
            y2="130"
            stroke="#333"
            stroke-width="1.5"
            id="speed-data"
          />

          <!-- ECU to Throttle -->
          <line
            x1="160"
            y1="140"
            x2="190"
            y2="85"
            stroke="#333"
            stroke-width="1.5"
            id="ecu-control"
          />

          <!-- Throttle to Engine -->
          <line
            x1="230"
            y1="75"
            x2="240"
            y2="120"
            stroke="#333"
            stroke-width="1.5"
            id="throttle-input"
          />

          <!-- Feedback From Engine to Speed Sensor -->
          <path
            d="M265,160 Q280,180 230,180 Q180,180 100,105"
            stroke="#333"
            stroke-width="1"
            stroke-dasharray="3,2"
            fill="none"
            id="feedback-loop"
            class="mechanical-part"
            data-title="Feedback Loop"
            data-description="The critical closed-loop system that enables cruise control. As engine power changes vehicle speed, the speed sensor detects these changes and sends updated information to the ECU. The ECU then adjusts throttle position to maintain the target speed, creating a continuous self-correcting system."
          ></path>

          <!-- Control connections -->
          <g
            class="mechanical-part"
            data-title="Manual Control Path"
            data-description="Direct mechanical or electronic connection from the accelerator pedal to the throttle. When cruise control is off, this is the active control path allowing the driver to directly manage vehicle speed."
          >
            <line
              x1="120"
              y1="60"
              x2="125"
              y2="65"
              stroke="transparent"
              stroke-width="20"
              id="manual-control-tooltip"
            />
          </g>

          <g
            class="mechanical-part"
            data-title="Cruise Command Signal"
            data-description="Electronic signal sent from the cruise control switch to the ECU. This signal initiates cruise control mode and sets the desired speed that the system will maintain."
          >
            <line
              x1="70"
              y1="115"
              x2="75"
              y2="120"
              stroke="transparent"
              stroke-width="20"
              id="cruise-command-tooltip"
            />
          </g>

          <g
            class="mechanical-part"
            data-title="ECU Control Signal"
            data-description="Electronic commands sent from the ECU to the throttle actuator. These precise signals adjust the throttle position to maintain consistent speed when cruise control is active."
          >
            <line
              x1="170"
              y1="110"
              x2="175"
              y2="115"
              stroke="transparent"
              stroke-width="20"
              id="ecu-control-tooltip"
            />
          </g>
        </svg>
      </div>
    </div>

    <!-- Info Popup Modal -->
    <div id="infoPopup">
      <div class="popup-content">
        <button class="popup-close">&times;</button>
        <div class="popup-title">Component Info</div>
        <div class="popup-description">
          Information about the component will appear here.
        </div>
      </div>
    </div>

    <script>
      let speed = 0;
      let cruiseEnabled = false;
      let cruiseSpeed = 0;
      let roadPosition = 0;
      let lastTime = 0;
      let isAccelerating = false; // New flag to track if accelerator is being pressed
      let isDecelerating = false; // New flag to track if brake is being pressed
      const MAX_SPEED = 120; // Maximum speed for our speedometer

      const road = document.getElementById("road");

      // Clear existing lane markers
      road.innerHTML = "";

      // Create two sets of lane markers that we'll animate in parallel
      const laneSet1 = document.createElement("div");
      laneSet1.className = "lane-set";
      laneSet1.style.position = "absolute";
      laneSet1.style.width = "100%";
      laneSet1.style.height = "100%";
      laneSet1.style.top = "0";

      const laneSet2 = document.createElement("div");
      laneSet2.className = "lane-set";
      laneSet2.style.position = "absolute";
      laneSet2.style.width = "100%";
      laneSet2.style.height = "100%";
      laneSet2.style.top = "-100%";

      road.appendChild(laneSet1);
      road.appendChild(laneSet2);

      // Create realistic dashed lane markers
      const lineCount = 15;
      const gapRatio = 3;

      for (let i = 0; i < lineCount; i++) {
        const linePosition =
          i * (1 + gapRatio) * (100 / (lineCount * (1 + gapRatio)));

        const line1 = document.createElement("div");
        line1.className = "lane-line";
        line1.style.top = `${linePosition}%`;
        laneSet1.appendChild(line1);

        const line2 = document.createElement("div");
        line2.className = "lane-line";
        line2.style.top = `${linePosition}%`;
        laneSet2.appendChild(line2);
      }

      // Create speedometer ticks and labels
      function createSpeedometerMarkings() {
        const container = document.querySelector(".speedometer-container");

        // Create ticks from -90 to 90 degrees (half circle)
        for (let i = 0; i <= 12; i++) {
          const angle = -90 + i * 15; // -90 to 90 in 15 degree steps
          const speed = Math.round(i * (MAX_SPEED / 12)); // Corresponding speed value

          // Create tick
          const tick = document.createElement("div");
          tick.className = i % 3 === 0 ? "speed-tick major" : "speed-tick";
          tick.style.transform = `rotate(${angle}deg)`;
          container.appendChild(tick);

          // Create label for major ticks
          if (i % 3 === 0) {
            const label = document.createElement("div");
            label.className = "speed-value";
            label.style.transform = `rotate(${angle}deg) translateX(-50%) rotate(${-angle}deg)`;
            label.textContent = speed;
            container.appendChild(label);
          }
        }
      }

      // Setup popup functionality
      function setupPopup() {
        const popup = document.getElementById("infoPopup");
        const popupTitle = document.querySelector(".popup-title");
        const popupDescription = document.querySelector(".popup-description");
        const closeButton = document.querySelector(".popup-close");

        // Close popup when clicking close button
        closeButton.addEventListener("click", () => {
          popup.style.display = "none";
        });

        // Close popup when clicking outside the content
        popup.addEventListener("click", (e) => {
          if (e.target === popup) {
            popup.style.display = "none";
          }
        });

        // Setup click handlers for mechanical parts
        document.querySelectorAll(".mechanical-part").forEach((part) => {
          part.addEventListener("click", function () {
            const title = this.getAttribute("data-title");
            const description = this.getAttribute("data-description");

            if (title && description) {
              popupTitle.textContent = title;
              popupDescription.textContent = description;
              popup.style.display = "flex";
            }
          });
        });
      }

      // Setup event listeners for button press/release
      // Update your setupEventListeners function by modifying the accelerator and brake button events

      function setupEventListeners() {
        const accelButton = document.querySelector(
          "#controls button:nth-child(1)"
        );
        const brakeButton = document.querySelector(
          "#controls button:nth-child(2)"
        );
        const cruiseButton = document.getElementById("cruiseButton");

        // Accelerator button events
        accelButton.addEventListener("mousedown", function () {
          // If cruise is enabled, turn it off
          if (cruiseEnabled) {
            cruiseEnabled = false;
            updateUI();
          }
          isAccelerating = true;
          accelButton.classList.add("active");
        });

        accelButton.addEventListener("mouseup", function () {
          isAccelerating = false;
          accelButton.classList.remove("active");
        });

        accelButton.addEventListener("mouseleave", function () {
          isAccelerating = false;
          accelButton.classList.remove("active");
        });

        // Brake button events
        brakeButton.addEventListener("mousedown", function () {
          // If cruise is enabled, turn it off
          if (cruiseEnabled) {
            cruiseEnabled = false;
            updateUI();
          }
          isDecelerating = true;
          brakeButton.classList.add("active");
        });

        brakeButton.addEventListener("mouseup", function () {
          isDecelerating = false;
          brakeButton.classList.remove("active");
        });

        brakeButton.addEventListener("mouseleave", function () {
          isDecelerating = false;
          brakeButton.classList.remove("active");
        });

        // Same change for touch events
        accelButton.addEventListener("touchstart", function (e) {
          e.preventDefault();
          // If cruise is enabled, turn it off
          if (cruiseEnabled) {
            cruiseEnabled = false;
            updateUI();
          }
          isAccelerating = true;
          accelButton.classList.add("active");
        });

        brakeButton.addEventListener("touchstart", function (e) {
          e.preventDefault();
          // If cruise is enabled, turn it off
          if (cruiseEnabled) {
            cruiseEnabled = false;
            updateUI();
          }
          isDecelerating = true;
          brakeButton.classList.add("active");
        });

        // Keep the remaining event listeners unchanged
        accelButton.addEventListener("touchend", function () {
          isAccelerating = false;
          accelButton.classList.remove("active");
        });

        brakeButton.addEventListener("touchend", function () {
          isDecelerating = false;
          brakeButton.classList.remove("active");
        });

        // Cruise control button
        cruiseButton.addEventListener("click", toggleCruise);
      }

      function updateUI() {
        // Update cruise control button status
        const cruiseIndicator = document.querySelector(".cruise-indicator");
        if (cruiseEnabled) {
          cruiseIndicator.textContent = `ON (${cruiseSpeed} km/h)`;
          cruiseIndicator.classList.add("on");
          document.getElementById("cruiseButton").classList.add("active");
        } else {
          cruiseIndicator.textContent = "OFF";
          cruiseIndicator.classList.remove("on");
          document.getElementById("cruiseButton").classList.remove("active");
        }

        // Update mechanics log
        document.getElementById("mechanicsLog").innerText = cruiseEnabled
          ? `ECU is controlling the throttle to maintain ${cruiseSpeed} km/h.`
          : isAccelerating
          ? "Driver pressing accelerator pedal to increase speed."
          : isDecelerating
          ? "Driver pressing brake pedal to decrease speed."
          : "Driver not pressing any pedals.";

        // Update speedometer display
        document.querySelector(".speed-display").textContent = `${speed.toFixed(
          1
        )} km/h`;

        // Calculate needle angle: map 0-MAX_SPEED to -90-90 degrees
        const needleAngle = -90 + (speed / MAX_SPEED) * 180;
        document.querySelector(
          ".speedometer-needle"
        ).style.transform = `rotate(${needleAngle}deg)`;

        document
          .getElementById("ecuLight")
          .setAttribute("fill", cruiseEnabled ? "green" : "gray");
        updateMechanicalDiagram();
      }

      // These functions are no longer needed as button clicks since we're using event listeners
      // But we'll keep them as the functions that actually modify the speed
      function accelerate() {
        if (!cruiseEnabled) speed += 0.5; // Reduced acceleration rate for smoother control
        if (speed > MAX_SPEED) speed = MAX_SPEED; // Cap to maximum speed
      }

      function decelerate() {
        if (!cruiseEnabled && speed > 0) {
          speed -= 0.5;
          if (speed < 0) speed = 0;
        }
      }

      function toggleCruise() {
        if (!cruiseEnabled && speed > 0) {
          cruiseEnabled = true;
          cruiseSpeed = speed.toFixed(1);
        } else {
          cruiseEnabled = false;
        }
        updateUI();
      }

      // Dynamic updates for the mechanical diagram
      function updateMechanicalDiagram() {
        // Update cruise control indicator
        document
          .getElementById("cruise-indicator")
          .setAttribute("fill", cruiseEnabled ? "green" : "gray");

        // Update throttle position visualization based on speed
        const throttleWidth = Math.min(30, (speed / 5) * 30);
        document
          .getElementById("throttle-position")
          .setAttribute("width", throttleWidth);

        // Highlight active control path
        if (cruiseEnabled) {
          // Highlight ECU control path when cruise is on
          document.getElementById("ecu-control").setAttribute("stroke", "#00c");
          document
            .getElementById("cruise-command")
            .setAttribute("stroke", "#00c");
          document.getElementById("speed-data").setAttribute("stroke", "#00c");
          document
            .getElementById("manual-control")
            .setAttribute("stroke", "#333");
          document
            .getElementById("manual-control")
            .setAttribute("stroke-opacity", "0.3");
          // Show feedback loop active
          document
            .getElementById("feedback-loop")
            .setAttribute("stroke", "#00c");
          document
            .getElementById("feedback-loop")
            .setAttribute("stroke-dasharray", "5,3");
        } else {
          // Highlight manual control path when cruise is off
          document
            .getElementById("manual-control")
            .setAttribute("stroke", "#c00");
          document
            .getElementById("manual-control")
            .setAttribute("stroke-opacity", "1");
          document.getElementById("ecu-control").setAttribute("stroke", "#333");
          document
            .getElementById("cruise-command")
            .setAttribute("stroke", "#333");
          document.getElementById("speed-data").setAttribute("stroke", "#333");
          // Show feedback loop inactive
          document
            .getElementById("feedback-loop")
            .setAttribute("stroke", "#333");
          document
            .getElementById("feedback-loop")
            .setAttribute("stroke-dasharray", "3,2");
        }
      }

      function updateMechanicalDiagramSpacing() {
        // Driver Input Section - Move to left
        document
          .getElementById("driver-input")
          .setAttribute("transform", "translate(-5, -5)");

        // Cruise Control Switch - Move down and to left
        document
          .getElementById("cruise-switch")
          .setAttribute("transform", "translate(-5, 15)");

        // ECU - Move to center
        document
          .getElementById("ecu-unit")
          .setAttribute("transform", "translate(20, 0)");

        // Speed Sensor - Move up
        document
          .getElementById("speed-sensor")
          .setAttribute("transform", "translate(0, -15)");

        // Throttle - Move to right
        document
          .getElementById("throttle")
          .setAttribute("transform", "translate(20, -10)");

        // Engine - Move to right and down
        document
          .getElementById("engine")
          .setAttribute("transform", "translate(15, 5)");

        // Update connection lines
        document.getElementById("manual-control").setAttribute("x1", "45");
        document.getElementById("manual-control").setAttribute("y1", "45");
        document.getElementById("manual-control").setAttribute("x2", "210");
        document.getElementById("manual-control").setAttribute("y2", "65");

        document.getElementById("cruise-command").setAttribute("x1", "45");
        document.getElementById("cruise-command").setAttribute("y1", "115");
        document.getElementById("cruise-command").setAttribute("x2", "120");
        document.getElementById("cruise-command").setAttribute("y2", "130");

        document.getElementById("speed-data").setAttribute("x1", "100");
        document.getElementById("speed-data").setAttribute("y1", "90");
        document.getElementById("speed-data").setAttribute("x2", "130");
        document.getElementById("speed-data").setAttribute("y2", "130");

        document.getElementById("ecu-control").setAttribute("x1", "180");
        document.getElementById("ecu-control").setAttribute("y1", "140");
        document.getElementById("ecu-control").setAttribute("x2", "210");
        document.getElementById("ecu-control").setAttribute("y2", "75");

        document.getElementById("throttle-input").setAttribute("x1", "250");
        document.getElementById("throttle-input").setAttribute("y1", "75");
        document.getElementById("throttle-input").setAttribute("x2", "255");
        document.getElementById("throttle-input").setAttribute("y2", "120");

        // Update feedback loop path
        document
          .getElementById("feedback-loop")
          .setAttribute("d", "M280,165 Q300,190 240,190 Q170,190 100,75");

        // Position tooltip trigger points
        document
          .getElementById("manual-control-tooltip")
          .setAttribute("x1", "120");
        document
          .getElementById("manual-control-tooltip")
          .setAttribute("y1", "60");
        document
          .getElementById("manual-control-tooltip")
          .setAttribute("x2", "125");
        document
          .getElementById("manual-control-tooltip")
          .setAttribute("y2", "65");

        document
          .getElementById("cruise-command-tooltip")
          .setAttribute("x1", "70");
        document
          .getElementById("cruise-command-tooltip")
          .setAttribute("y1", "115");
        document
          .getElementById("cruise-command-tooltip")
          .setAttribute("x2", "75");
        document
          .getElementById("cruise-command-tooltip")
          .setAttribute("y2", "120");

        document
          .getElementById("ecu-control-tooltip")
          .setAttribute("x1", "170");
        document
          .getElementById("ecu-control-tooltip")
          .setAttribute("y1", "110");
        document
          .getElementById("ecu-control-tooltip")
          .setAttribute("x2", "175");
        document
          .getElementById("ecu-control-tooltip")
          .setAttribute("y2", "115");
      }

      function simulateDrive(currentTime) {
        if (!lastTime) lastTime = currentTime;
        const deltaTime = (currentTime - lastTime) / 1000;
        lastTime = currentTime;

        if (cruiseEnabled) {
          // Cruise control maintains speed
          speed += (cruiseSpeed - speed) * 0.05;
        } else {
          // Manual control - apply acceleration or deceleration based on button state
          if (isAccelerating) {
            accelerate();
          } else if (isDecelerating) {
            decelerate();
          } else {
            // Natural deceleration when no pedal is pressed
            if (speed > 0) {
              speed -= 0.1 * deltaTime * 10; // Gradual slow down when not accelerating
              if (speed < 0) speed = 0;
            }
          }
        }

        if (speed > 0) {
          // Update road position with positive value (0-100%)
          roadPosition += speed * deltaTime * 0.5;

          // When position exceeds 100%, reset to continue the loop
          if (roadPosition >= 100) {
            roadPosition = 0;
          }

          // Apply transforms to both lane sets
          laneSet1.style.transform = `translateY(${roadPosition}%)`;
          laneSet2.style.transform = `translateY(${roadPosition}%)`;
        }

        updateUI();
        requestAnimationFrame(simulateDrive);
      }

      // Initialize when the DOM is fully loaded
      document.addEventListener("DOMContentLoaded", function () {
        createSpeedometerMarkings();
        updateMechanicalDiagramSpacing();
        setupEventListeners();
        setupPopup();

        // Start the animation loop
        requestAnimationFrame(simulateDrive);

        // Add a title to the mechanical diagram
        document.querySelector(".mechanical-diagram").prepend(diagramTitle);
      });
    </script>
  </body>
</html>
